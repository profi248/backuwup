<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Peer-to-peer backup</title>
    <style>
        #app {
            display: none;
        }

        #logs {
            white-space: pre;
            overflow-wrap: normal;
            overflow-x: scroll;
            display: block;
            font-size: 1.2em;
            font-family: 'Fira Code', monospace;
        }

        @font-face {
            font-family: 'Mulish';
            font-style: normal;
            font-weight: 400;
            font-display: swap;
            src: url('/fonts/Mulish-Regular.ttf') format('truetype');
        }
        @font-face {
            font-family: 'Mulish';
            font-style: italic;
            font-weight: 400;
            font-display: swap;
            src: url('/fonts/Mulish-Italic.ttf') format('truetype');
        }
        @font-face {
            font-family: 'Mulish';
            font-style: normal;
            font-weight: 600;
            font-display: swap;
            src: url('/fonts/Mulish-SemiBold.ttf') format('truetype');
        }
        @font-face {
            font-family: 'Mulish';
            font-style: italic;
            font-weight: 600;
            font-display: swap;
            src: url('/fonts/Mulish-SemiBoldItalic.ttf') format('truetype');
        }
        @font-face {
            font-family: 'Fira Code';
            font-style: normal;
            font-weight: 400;
            font-display: swap;
            src: url('/fonts/FiraCode-Regular.ttf') format('truetype');
        }
        * {
            font-family: 'Mulish', sans-serif;
        }

    </style>
    <link rel="stylesheet" href="lib/bootstrap.min.css">
</head>
<body>
    <div id="app">
        <nav class="navbar py-3 mb-3">
            <div class="container">
                <a class="navbar-brand">Backup</a>
                <form class="d-flex">
                    <div id="status" v-if="status"><h5><span class="badge rounded-pill text-bg-success">Connected</span></h5></div>
                    <div id="status" v-else><h5><span class="badge rounded-pill text-bg-danger">Disconnected</span></h5></div>
                </form>
            </div>
        </nav>
        <div class="container">
            <h1 class="text-center">Log</h1>
            <textarea class="w-100 rounded-2 border border-2 p-3 text-body mt-4 mx-auto" rows="15" id="logs" disabled>{{ logs }}</textarea>
        </div>
    </div>

    <script src="lib/vue.global.min.js"></script>
    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    logs: "",
                    status: false,
                    socket: null,
                    reconnector: null
                }
            },
            methods: {
                connect_ws() {
                    this.socket = new WebSocket(`ws://${window.location.host}/ws`);

                    this.socket.addEventListener('message', (event) => {
                        console.log('Message from server ', event.data);
                        this.logs += event.data + "\n";

                        let el = document.querySelector("#logs");
                        el.scrollTo(0, el.scrollHeight);
                    });

                    this.socket.addEventListener('open', (event) => {
                        this.status = true;
                        clearInterval(this.reconnctor);
                    });

                    this.socket.addEventListener('close', () => {
                        this.closed_ws();
                    });

                    this.socket.addEventListener('error', () => {
                        this.closed_ws();
                    });
                },
                closed_ws() {
                    this.socket = null;
                    this.status = false;
                    clearInterval(this.reconnctor);
                    this.reconnctor = setInterval(() => { this.connect_ws() }, 1000);
                },
            },
            mounted() {
                document.querySelector("#app").style.display = "block";
                this.connect_ws();
            }
        }).mount('#app');
    </script>
</body>
</html>
